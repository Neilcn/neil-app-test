<script src="{{ 'product.js' | asset_url }}" defer></script>

{% stylesheet %}
  .bundle-product {
    display: flex;
    align-items: center;
    flex-direction: column;
    border: solid 1px black;
    border-radius: 5px;
    padding: 10px;
  }
  .bundle-product-card {
    display: flex;
    align-items: flex-start;
  }
  .bundle-product img {
    margin-right: 10px;
  }
  .bundle-product p {
    margin: 0;
  }
{% endstylesheet %}

<product-page>
  <h1>{{ product.title }}</h1>

  <div class="product-price">FROM: {{ product.price | money }}</div>

  <img
    class="product-image"
    src="{{ product.selected_or_first_available_variant.featured_image | image_url: width:400 }}"
    alt="{{ product.selected_or_first_available_variant.alt | escape }}"
    width="400"
    height=""
  >
  {% if product.images.size > 1 %}
    <div class="product-image-grid">
      {% for image in product.images %}
        <img class="" src="{{ image | image_url: width:100 }}" alt="{{ image.alt | escape }}" width="100" height="">
      {% endfor %}
      {% if product.metafields.custom.bundle_product %}
        {% assign bundle_product_gid = product.metafields.custom.bundle_product %}
        {% assign bundle_product = bundle_product_gid.value %}
          <img
            src="{{ bundle_product.featured_image | image_url: width: 100 }}"
            alt="{{ bundle_product.title | default: 'Bundle Product' | escape }}"
            width="100"
            height="100"
          >
        {% endif %}
    </div>
  {% endif %}

  {% form 'product', product %}
    {% comment %} <input type="hidden" name="id" value="{{ product.variants.first.id }}"> {% endcomment %}
    {% if product.variants.size > 1 %}
      <label for="ProductSelect">Options</label>

      {% for option in product.options_with_values %}
        <select class="product-option product-option-{{ forloop.index }}">
          {% for value in option.values %}
            <option
              value="{{ value.name }}"
              {% if value.selected %}
                selected
              {% endif %}
            >
              {{ value.name }}
            </option>
          {% endfor %}
        </select>
      {% endfor %}

      <select name="id" id="ProductSelect" class="product-variant-select">
        {% for variant in product.variants %}
          <option
            value="{{ variant.id }}"
            {% if variant.selected %}
              selected
            {% endif %}
          >
            {{ variant.title }} - {{ variant.price | money }}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    {% if product.selected_or_first_available_variant.available %}
      <button type="submit">Add to Cart</button>
    {% else %}
      <button type="submit" disabled>Sold Out</button>
    {% endif %}
  {% endform %}

  {% if product.metafields.custom.bundle_product %}
    {% assign bundle_product_gid = product.metafields.custom.bundle_product.value %}
    {% comment %} Extract product ID from GID string {% endcomment %}
    {% assign gid_parts = bundle_product_gid | split: '/' %}
    {% assign bundle_product_id = gid_parts[4] %}
    
    {% comment %} Find the product by iterating through all products with type conversion {% endcomment %}
    {% assign bundle_product = null %}
    {% assign bundle_product_id_string = bundle_product_id | append: '' %}
    

      {% for product_item in shop.products %}
        {% assign current_id_string = product_item.id | append: '' %}
        {% if current_id_string == bundle_product_id_string %}
          {% assign bundle_product = product_item %}
          {% break %}
        {% endif %}
      {% endfor %}

    

    <bundle-card>
      <div
        class="bundle-product"
        data-bundle-variant-id="{{ bundle_product.selected_or_first_available_variant.id }}"
      >
        <h2>This is a bundle product</h2>
        <div class="bundle-product-card">
          <img
            src="{{ bundle_product.featured_image | image_url: width: 50 }}"
            alt="{{ bundle_product.title | default: 'Bundle Product' | escape }}"
            width="50"
            height="50"
          >
          <p>
            <strong class="bundle-product-value-title">{{ bundle_product.title }}</strong>
          </p>
        </div>
      </div>
    </bundle-card>
  {% endif %}

  <script id="product-variants-json" type="application/json">
    {{ product.variants | json }}
  </script>
</product-page>

{% schema %}
{
  "name": "Product Section",
  "settings": [],
  "presets": [
    {
      "name": "Product Section"
    }
  ]
}
{% endschema %}
